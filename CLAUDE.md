# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

18xx board game rules summary site built with **MkDocs + Material for MkDocs** (Python). Each game gets a Markdown page with tabbed sections (SR/OR/setup), a printable layout, and a downloadable plain-text export. Game metadata (player count, play time, designer, cover images) is pulled from BoardGameGeek's XML API and rendered via Jinja macros.

The project owner is a non-engineer. AI agents handle technical validation and file plumbing only — never judge or rewrite rule content, Japanese phrasing, or game accuracy. See `AGENTS.md` for the full role-separation policy.

## Commands

```bash
# Activate venv (Windows)
.\.venv\Scripts\activate

# Local preview
mkdocs serve

# Test-config preview
mkdocs serve -f mkdocs-test.yml

# Regenerate all plain-text exports (docs/assets/*.txt)
python scripts/export_text.py

# Auto-indent tab blocks in game Markdown
python scripts/indent_tabs.py                          # all games
python scripts/indent_tabs.py docs/games/18Chesapeake.md  # single file

# Validate game page structure + .pages/index alignment
python scripts/validate_structure.py

# Fetch BGG metadata & cover images (needs BGG_TOKEN env var)
python scripts/bgg_fetch.py

# Run tests
python -m pytest tests/

# Build static site
mkdocs build
```

## Architecture

### Content flow

```
docs/games/<Game>.md  ──(mkdocs build)──▶  site/
        │                                     ▲
        │                                     │
        ▼                                     │
scripts/export_text.py ──▶ docs/assets/<Game>.txt
                                              │
docs/assets/bgg-meta.json ──(main.py macros)──┘
```

### Key files

| Path | Role |
|---|---|
| `docs/games/*.md` | Game summary pages (editable content) |
| `docs/games/index.md` | Game list page — uses `game_card()` macro |
| `docs/games/.pages` | Navigation order (awesome-pages plugin) |
| `main.py` | mkdocs-macros `define_env` — registers Jinja macros (`game_card`, `game_cover`, `game_title`, `game_actions`, `print_button`, `download_link`, `icon`) |
| `docs/assets/bgg-meta.json` | BGG metadata cache, keyed by bgg_id string |
| `docs/assets/game-covers/` | WebP cover images resized from BGG |
| `scripts/export_text.py` | Markdown → plain-text converter |
| `scripts/indent_tabs.py` | Ensures 4-space indent inside `=== "..."` tab blocks |
| `scripts/validate_structure.py` | Checks required structure of game pages and cross-file consistency |
| `scripts/bgg_fetch.py` | BGG XML API2 fetcher → `bgg-meta.json` + cover images |
| `mkdocs.yml` | Site config (Material theme, plugins: search, awesome-pages, macros) |

### Game page required structure

Each `docs/games/<Game>.md` must have:

1. Frontmatter with `bgg_id`
2. `# <Game Name> サマリー` title
3. `<div class="actions">` block containing `print_button()`, back link, and `download_link("<Game>.txt")`
4. Tabs: `=== "SR"`, `=== "OR"`, and a setup tab (`=== "セットアップ / 早見"` or `=== "会社の種類 / 準備"` + `=== "早見表"`)
5. All tab content indented 4 spaces

### Adding a new game

1. Create `docs/games/<Game>.md` following the structure above
2. Add entry to `docs/games/.pages` nav (sorted)
3. Add `game_card()` call to `docs/games/index.md` (sorted)
4. Run `python scripts/export_text.py` to generate `.txt`
5. Run `python scripts/validate_structure.py` to verify

### Do-not-modify files

- `docs/stylesheets/extra.css` — print/mobile layout
- `.github/workflows/` — CI/CD pipeline
- `docs/assets/*.txt` — auto-generated by `export_text.py`, never hand-edit

### CI/CD

GitHub Actions (`.github/workflows/deploy.yml`): on push to `main`, runs `export_text.py`, commits generated `.txt` files, builds with `mkdocs build`, and deploys to GitHub Pages.

### Line endings

Repository is LF-normalized (`.gitattributes`). Scripts write with `newline="\n"`.
